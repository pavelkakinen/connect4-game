@page "{id:int}"
@model WebApp.Pages.Students.DetailsModel
@{
    ViewData["Title"] = Model.Student.FullName;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>@Model.Student.FullName</h1>
        <p class="text-muted mb-0">Member since @Model.Student.RegistrationDate.ToString("MMMM dd, yyyy")</p>
    </div>
    <div>
        <a asp-page="Edit" asp-route-id="@Model.Student.Id" class="btn btn-outline-primary">Edit Student</a>
        <a asp-page="Index" class="btn btn-outline-secondary">Back to List</a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <!-- Left Column: Info and Stats -->
    <div class="col-md-4">
        <!-- Contact Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Contact Information</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8">@Model.Student.Email</dd>
                    <dt class="col-sm-4">Phone</dt>
                    <dd class="col-sm-8">@(Model.Student.Phone ?? "Not provided")</dd>
                </dl>
            </div>
        </div>

        <!-- Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h3 class="mb-0">@Model.TotalBookings</h3>
                        <small class="text-muted">Total Bookings</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h3 class="mb-0">@Model.AttendedCount</h3>
                        <small class="text-muted">Attended</small>
                    </div>
                    <div class="col-6">
                        <h3 class="mb-0 @(Model.AttendanceRate >= 80 ? "text-success" : Model.AttendanceRate >= 50 ? "text-warning" : "text-danger")">
                            @Model.AttendanceRate.ToString("F0")%
                        </h3>
                        <small class="text-muted">Attendance Rate</small>
                    </div>
                    <div class="col-6">
                        @if (Model.HighestLevel.HasValue)
                        {
                            <h3 class="mb-0">
                                <span class="badge @Model.GetLevelBadgeClass(Model.HighestLevel.Value)">@Model.HighestLevel</span>
                            </h3>
                        }
                        else
                        {
                            <h3 class="mb-0 text-muted">-</h3>
                        }
                        <small class="text-muted">Highest Level</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Showcase Eligibility -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Showcase Eligibility</h5>
            </div>
            <div class="card-body">
                @if (Model.IsShowcaseEligible)
                {
                    <div class="alert alert-success mb-0">
                        <strong>Eligible!</strong> This student qualifies for showcase performances.
                    </div>
                }
                else
                {
                    <div class="alert alert-warning mb-0">
                        <strong>Not Yet Eligible</strong>
                        <ul class="mb-0 mt-2">
                            @if (Model.AttendanceRate < 80)
                            {
                                <li>Needs 80%+ attendance (currently @Model.AttendanceRate.ToString("F0")%)</li>
                            }
                            @if (!Model.HighestLevel.HasValue || (int)Model.HighestLevel.Value < (int)ClassLevel.Intermediate)
                            {
                                <li>Needs to complete Intermediate+ level classes</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>

        <!-- Trial Classes -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Trial Classes</h5>
            </div>
            <div class="card-body">
                @if (Model.TrialUsages.Any())
                {
                    <p class="mb-2"><strong>Used trials:</strong></p>
                    <div class="mb-3">
                        @foreach (var trial in Model.TrialUsages)
                        {
                            <span class="badge bg-secondary me-1">@trial.DanceStyle.Name</span>
                        }
                    </div>
                }
                @if (Model.AvailableTrialStyles.Any())
                {
                    <p class="mb-2"><strong>Available trials:</strong></p>
                    <div>
                        @foreach (var style in Model.AvailableTrialStyles)
                        {
                            <span class="badge text-primary border border-primary me-1">@style.Name</span>
                        }
                    </div>
                }
                else if (!Model.TrialUsages.Any())
                {
                    <p class="text-muted mb-0">No trials used. All styles available for free trial.</p>
                }
                else
                {
                    <p class="text-muted mb-0">All trial classes have been used.</p>
                }
            </div>
        </div>
    </div>

    <!-- Right Column: Packages and Bookings -->
    <div class="col-md-8">
        <!-- Current Package -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Current Package</h5>
            </div>
            <div class="card-body">
                @if (Model.ActivePackage != null)
                {
                    var pkg = Model.ActivePackage;
                    <div class="row">
                        <div class="col-md-6">
                            <h6>@Model.GetPackageTypeName(pkg.PackageType)</h6>
                            @if (pkg.DanceStyle != null)
                            {
                                <p class="mb-1"><strong>Style:</strong> @pkg.DanceStyle.Name</p>
                            }
                            <p class="mb-1"><strong>Purchased:</strong> @pkg.PurchaseDate.ToString("MMM dd, yyyy")</p>
                            <p class="mb-0"><strong>Expires:</strong> @pkg.ExpiryDate.ToString("MMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            @if (pkg.RemainingClasses.HasValue)
                            {
                                <h2 class="@(pkg.HasLowBalance ? "text-warning" : "text-success")">
                                    @pkg.RemainingClasses <small class="text-muted">classes left</small>
                                </h2>
                                @if (pkg.HasLowBalance)
                                {
                                    <span class="badge bg-warning text-dark">Low Balance!</span>
                                }
                            }
                            else
                            {
                                <h4 class="text-success">Unlimited</h4>
                                <small class="text-muted">@((pkg.ExpiryDate - DateTime.Today).Days) days remaining</small>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted mb-0">No active package.</p>
                }
            </div>
        </div>

        <!-- Assign New Package -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Assign New Package</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="AssignPackage" asp-route-id="@Model.Student.Id" class="row g-3">
                    <div class="col-md-5">
                        <label asp-for="PackageInput.PackageType" class="form-label">Package Type</label>
                        <select asp-for="PackageInput.PackageType" asp-items="Model.PackageTypeOptions" class="form-select" id="packageType">
                        </select>
                    </div>
                    <div class="col-md-4" id="styleSelectContainer">
                        <label asp-for="PackageInput.DanceStyleId" class="form-label">Dance Style</label>
                        <select asp-for="PackageInput.DanceStyleId" asp-items="Model.DanceStyleOptions" class="form-select">
                            <option value="">Select style...</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Assign Package</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Book Class -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Book Class</h5>
            </div>
            <div class="card-body">
                @if (!Model.ActivePackage?.IsValid == true && !Model.AvailableTrialStyles.Any())
                {
                    <div class="alert alert-warning mb-0">
                        <strong>Cannot book:</strong> No valid package and no trial classes available.
                        Please assign a package first.
                    </div>
                }
                else
                {
                    <form method="post" asp-page-handler="BookClass" asp-route-id="@Model.Student.Id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="BookingInput.ClassId" class="form-label">Select Class</label>
                                <select asp-for="BookingInput.ClassId" class="form-select" id="classSelect" required>
                                    <option value="">-- Select a class --</option>
                                    @foreach (var styleGroup in Model.AvailableClasses.GroupBy(c => c.DanceStyle.Name))
                                    {
                                        <optgroup label="@styleGroup.Key">
                                            @foreach (var dc in styleGroup)
                                            {
                                                var validPkgs = Model.GetValidPackagesForClass(dc);
                                                var canTrial = Model.CanUseTrial(dc.DanceStyleId);
                                                var canBook = validPkgs.Any() || canTrial;
                                                @if (canBook)
                                                {
                                                    <option value="@dc.Id"
                                                            data-day="@((int)dc.DayOfWeek)"
                                                            data-style-id="@dc.DanceStyleId"
                                                            data-can-trial="@canTrial.ToString().ToLower()"
                                                            data-packages="@string.Join(",", validPkgs.Select(p => p.Id))">
                                                        @dc.DayOfWeek @dc.StartTime.ToString(@"hh\:mm") - @dc.Level (@dc.InstructorName)
                                                    </option>
                                                }
                                                else
                                                {
                                                    <option value="@dc.Id" disabled>
                                                        @dc.DayOfWeek @dc.StartTime.ToString(@"hh\:mm") - @dc.Level (@dc.InstructorName) [No valid payment]
                                                    </option>
                                                }
                                            }
                                        </optgroup>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label asp-for="BookingInput.BookingDate" class="form-label">Date</label>
                                <input asp-for="BookingInput.BookingDate" type="date" class="form-control" id="bookingDate"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>
                            <div class="col-md-3">
                                <label asp-for="BookingInput.PaymentMethod" class="form-label">Payment</label>
                                <select asp-for="BookingInput.PaymentMethod" class="form-select" id="paymentMethod" required>
                                    <option value="">-- Select class first --</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success" id="bookBtn" disabled>Book Class</button>
                        </div>
                    </form>
                }
            </div>
        </div>

        <!-- Package History -->
        @if (Model.Packages.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Package History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Type</th>
                                    <th>Style</th>
                                    <th>Purchased</th>
                                    <th>Expires</th>
                                    <th>Remaining</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var pkg in Model.Packages)
                                {
                                    <tr class="@(pkg.IsExpired ? "table-secondary" : pkg.HasLowBalance ? "table-warning" : "")">
                                        <td>@Model.GetPackageTypeName(pkg.PackageType)</td>
                                        <td>@(pkg.DanceStyle?.Name ?? "All")</td>
                                        <td>@pkg.PurchaseDate.ToString("MMM dd, yyyy")</td>
                                        <td>@pkg.ExpiryDate.ToString("MMM dd, yyyy")</td>
                                        <td>@(pkg.RemainingClasses?.ToString() ?? "Unlimited")</td>
                                        <td>
                                            @if (pkg.IsExpired)
                                            {
                                                <span class="badge bg-secondary">Expired</span>
                                            }
                                            else if (pkg.RemainingClasses == 0)
                                            {
                                                <span class="badge bg-secondary">Used Up</span>
                                            }
                                            else if (pkg.HasLowBalance)
                                            {
                                                <span class="badge bg-warning text-dark">Low</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- Recent Bookings -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Bookings</h5>
            </div>
            <div class="card-body p-0">
                @if (Model.RecentBookings.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Level</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var booking in Model.RecentBookings)
                                {
                                    var isFuture = booking.BookingDate.Date >= DateTime.Today;
                                    <tr>
                                        <td>@booking.BookingDate.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            @booking.DanceClass.DanceStyle.Name
                                            <small class="text-muted">(@booking.DanceClass.StartTime.ToString(@"hh\:mm"))</small>
                                        </td>
                                        <td>
                                            <span class="badge @Model.GetLevelBadgeClass(booking.DanceClass.Level)">
                                                @booking.DanceClass.Level
                                            </span>
                                        </td>
                                        <td>
                                            @if (booking.IsTrial)
                                            {
                                                <span class="badge bg-info">Trial</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-primary">Regular</span>
                                            }
                                        </td>
                                        <td>
                                            @if (booking.Attended == true)
                                            {
                                                <span class="text-success">Attended</span>
                                            }
                                            else if (booking.Attended == false)
                                            {
                                                <span class="text-danger">Missed</span>
                                            }
                                            else if (isFuture)
                                            {
                                                <span class="text-primary">Upcoming</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Pending</span>
                                            }
                                        </td>
                                        <td>
                                            @if (isFuture && !booking.Attended.HasValue)
                                            {
                                                <form method="post" asp-page-handler="CancelBooking"
                                                      asp-route-id="@Model.Student.Id"
                                                      asp-route-bookingId="@booking.Id"
                                                      onsubmit="return confirm('Are you sure you want to cancel this booking for @booking.DanceClass.DanceStyle.Name on @booking.BookingDate.ToString("MMM dd")?');"
                                                      style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">Cancel</button>
                                                </form>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-3 text-muted">No bookings yet.</div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Package type toggle
        document.getElementById('packageType').addEventListener('change', function() {
            var styleContainer = document.getElementById('styleSelectContainer');
            if (this.value === '1') {
                styleContainer.style.display = 'block';
            } else {
                styleContainer.style.display = 'none';
            }
        });
        document.getElementById('packageType').dispatchEvent(new Event('change'));

        // Booking form handling
        var classSelect = document.getElementById('classSelect');
        var bookingDate = document.getElementById('bookingDate');
        var paymentMethod = document.getElementById('paymentMethod');
        var bookBtn = document.getElementById('bookBtn');

        // Package data from server
        var packages = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Packages.Where(p => p.IsValid).Select(p => new {
                id = p.Id,
                name = Model.GetPackageTypeName(p.PackageType) + (p.DanceStyle != null ? $" ({p.DanceStyle.Name})" : ""),
                remaining = p.RemainingClasses
            })
        ));

        if (classSelect) {
            classSelect.addEventListener('change', function() {
                var option = this.options[this.selectedIndex];
                if (!option.value) {
                    paymentMethod.innerHTML = '<option value="">-- Select class first --</option>';
                    bookBtn.disabled = true;
                    return;
                }

                var dayOfWeek = parseInt(option.dataset.day);
                var canTrial = option.dataset.canTrial === 'true';
                var pkgIds = option.dataset.packages ? option.dataset.packages.split(',').filter(x => x) : [];

                // Update date to next occurrence of this day
                var today = new Date();
                var diff = dayOfWeek - today.getDay();
                if (diff <= 0) diff += 7;
                var nextDate = new Date(today);
                nextDate.setDate(today.getDate() + diff);
                bookingDate.value = nextDate.toISOString().split('T')[0];

                // Update payment options
                paymentMethod.innerHTML = '';
                if (canTrial) {
                    var opt = document.createElement('option');
                    opt.value = 'trial';
                    opt.textContent = 'Free Trial';
                    paymentMethod.appendChild(opt);
                }
                pkgIds.forEach(function(pkgId) {
                    var pkg = packages.find(p => p.id == pkgId);
                    if (pkg) {
                        var opt = document.createElement('option');
                        opt.value = 'package_' + pkg.id;
                        opt.textContent = pkg.name + (pkg.remaining ? ' (' + pkg.remaining + ' left)' : '');
                        paymentMethod.appendChild(opt);
                    }
                });

                if (paymentMethod.options.length === 0) {
                    paymentMethod.innerHTML = '<option value="">No valid payment method</option>';
                    bookBtn.disabled = true;
                } else {
                    bookBtn.disabled = false;
                }
            });
        }
    </script>
}
